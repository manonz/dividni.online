<!doctype html>
<html lang="en">
<head>
   <meta charset="utf-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1" />
   <link rel="icon" type="image/svg+xml" href="https://dividni.com/images/Dividni-Logo.svg" />
   <link rel="mask-icon" href="https://dividni.com/images/Dividni-Logo-Black.svg" color="red" />
   <title>Scanera</title>
   <style>
      body {
         font-family: sans-serif;
         margin: 0;
         padding: 1rem;
         background: #f9f9f9;
      }

      main {
         text-align: center;
         max-width: 600px;
         margin: 0 auto;
      }

      h2 {
         font-size: clamp(1.2rem, 4vw, 2rem);
         margin-bottom: 2rem;
      }

      input {
         width: 100%;
         max-width: 400px;
         padding: 0.5rem;
         font-size: 1rem;
         margin-bottom: 1rem;
         border: 1px solid #ccc;
         border-radius: 6px;
      }

      video, canvas, img {
         width: 100%;
         max-width: 100%;
         height: auto;
         border: 1px solid #ccc;
         border-radius: 8px;
         margin-top: 10px;
         background: #000; /* fallback for camera feed */
      }

      p {
         margin-top: 0.5rem;
         font-size: 0.9rem;
         color: #555;
      }
   </style>
</head>
<body>
   <main>
      <h2>Scanera: Scan ID and Capture Photo</h2>

      <label for="fileInput">Upload student ID list (comma or newline separated):</label><br>
      <input type="file" id="fileInput" accept=".txt"><br><br>

      <input type="text" id="nameInput" placeholder="Scanned ID hereâ€¦" autofocus="autofocus">

      <div>
         <video id="video" autoplay="autoplay" playsinline="playsinline"></video>
         <canvas id="canvas" style="display: none;"></canvas>
         <img id="captured" />
      </div>

      <p id="status"></p>
   </main>

   <script>
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const captured = document.getElementById('captured');
      const input = document.getElementById('nameInput');
      const status = document.getElementById('status');
      const statusDefaultColour = status.style.color;
      let idList = [];

      document.getElementById('fileInput').addEventListener('change', function (event) {
         const file = event.target.files[0];
         if (!file) return;

         const reader = new FileReader();
         reader.onload = function (e) {
            const content = e.target.result;
            idList = content.split(/[\s,]+/).filter(str => {
               if (str === null || str === undefined) {
                  return false;
               }
               return typeof str === 'string' && str.trim().length > 0;
            });
            document.getElementById('status').textContent = `File loaded with ${idList.length} IDs.`;
         };
         reader.readAsText(file);
      });

      // Start camera stream
      navigator.mediaDevices.getUserMedia({ video: true })
         .then(stream => video.srcObject = stream)
         .catch(err => status.textContent = "Camera error: " + err);

      input.addEventListener('keydown', e => {
         if (e.key === "Enter") {
            const text = input.value.trim();
            status.style.color = statusDefaultColour;
            if (!text) {
               status.textContent = "Please enter a valid ID.";
               return;
            }

            if (idList.length > 0) {
               if (!idList.includes(text)) {
                  status.textContent = `ID ${text} does NOT exist in the ID list.`;
                  status.style.color = 'red';
                  return;
               }
            }

            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            // Show captured image
            captured.src = canvas.toDataURL("image/jpeg");

            // Trigger download
            const link = document.createElement('a');
            link.download = text.replace(/[^\w\d-_]/g, "_") + ".jpg";
            link.href = captured.src;
            link.click();

            status.textContent = "Saved as " + link.download;
         }
      });
   </script>
</body>
</html>
